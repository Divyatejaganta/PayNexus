sequenceDiagram
  participant Client
  participant API as API Gateway
  participant ORC as Orchestrator
  participant RED as Redis (Idempotency)
  participant LED as Ledger Service
  participant FRAUD as Fraud Engine
  participant GATE as Payment Gateway
  participant KAF as Kafka
  participant NOT as Notification Service

  Client->>API: POST /payments/qr-pay (Idempotency-Key)
  API->>ORC: forward request
  ORC->>RED: GET idempotency-key
  alt key exists
    RED-->>ORC: transaction id
    ORC-->>API: return stored response
  else
    ORC->>LED: INSERT ledger entry (PENDING)
    ORC->>FRAUD: sync check
    FRAUD-->>ORC: ALLOW
    ORC->>GATE: capture payment
    GATE-->>ORC: success
    ORC->>LED: finalize ledger (COMMIT)
    ORC->>KAF: emit payments.events
    ORC->>RED: STORE idempotency-key -> txid (TTL)
    ORC-->>API: 200/202 (transaction_id)
    KAF-->>NOT: consumer triggers webhook (async)
  end
